name: "Build RuleSet"

on:
  schedule:
    - cron: "0 20 * * *"   # UTC 20:00（= 中国时间+8 的 04:00）
  workflow_dispatch:

jobs:
  update-rule-set:
    name: "Update sing-box rule-set"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Setup sing-box"
        env:
          SING_BOX_DEB_URL: "https://github.com/SagerNet/sing-box/releases/download/v1.12.13/sing-box_1.12.13_linux_amd64.deb"
        run: |
          set -Eeuo pipefail
          wget -O sing-box.deb "$SING_BOX_DEB_URL"
          sudo dpkg -i sing-box.deb
          rm -f sing-box.deb
          sing-box version

      - name: "Setup python venv"
        run: |
          set -Eeuo pipefail
          python3 -m venv venv
          source venv/bin/activate
          pip3 install -U pip
          pip3 install -r requirements.txt

      - name: "Update rule-set"
        run: |
          set -Eeuo pipefail
          source venv/bin/activate
          python3 main.py

      - name: "Compile rule-set"
        run: |
          set -Eeuo pipefail
          bash compile.sh

      - name: "Commit and push"
        run: |
          set -Eeuo pipefail
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git add -A
          git commit -m "Update rule-sets" || echo "No changes"
          git push
